---
title: "hydrograph"
author: "Wenlong"
date: "4/15/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data_preparation, echo=FALSE, message=F}
# data processing.
require(dataRetrieval)
require(tidyverse)
# Informaton of USGS site.
station_id = "03094000"
# 00060 discharge (ft^3/s), 00045 precipitation (inches)
parameters_id = c("00060", "00045") 
start_date = "2018-01-01"
end_date = "2018-03-31"
# retrieve data from usgs.
data = readNWISuv(siteNumbers = station_id,
                  parameterCd = parameters_id,
                  startDate = start_date,
                  endDate = end_date)
# clean the data.
clean_data = data %>% 
  select(dateTime, X_00045_00000, X_00060_00000) %>% 
  mutate(precipitation = X_00045_00000,
         discharge = X_00060_00000) %>% 
  select(-c(X_00045_00000, X_00060_00000)) %>% 
  # change unit. discharge: m^3/s precipitation: cm.
  mutate(precipitation = precipitation * 2.54,
         discharge = round(discharge * 0.0283168, 2))
# save to file. 
write.csv(clean_data,"../data/sample_data.csv")
```

对于水文工作者来说，降雨-水文过程线图是最基础的数据展示方式，能够制作一张符合要求的水文过程线图(hydrograph)是一项必备技能。笔者今天简要介绍一下降雨-水文过程线图，然后着重介绍几种常用的图表制作软件和制作过程。

## 1. 降雨水文过程线图介绍

现在科学的核心假定之一是质量守恒与能量守恒定律 (mass balance).  在水文学中，质量守恒的体现形式之一就是水循环，包括全球大循环与区域小循环。对于全球大循环，海洋的中通过蒸发进入大气层，然后运移到大陆形成降水；降水汇集到河道形成径流，最后在流入海洋。当我们研究河流时，一般认为水文过程是降水驱动的。因此，我们经常讲降雨和水文过程画在一起，形成降雨-水文过程线图。

![](http://map.ps123.net/world/UploadFile/201503/2015031023542662.jpg)
Fig.1 全球水循环示意图

Fig.2 是一张典型的降雨(precipitation) - 水文过程线图(Hydrograph)。习惯上，我们将x轴设置为时间轴，例如小时，天数或者月份等等；y轴设置为径流量，单位为立方米每秒，有时候也会用深度的概念，即所有径流量铺在相应面积上的水层厚度来表示水量。需要注意的是，很多水文学工作者倾向于将降水设置为柱状图，倒过来放在水文过程的上方。这种构图首先展示了该水文过程是相应降水驱动的，其次要能够表征一些参数，例如洪峰滞时(Fig. 2中的Lag)既是降雨中心至洪峰出现的时间。

![](http://4.bp.blogspot.com/-52kbcyXSmpI/T4iEqMFMoQI/AAAAAAAACIo/HK-p4Orgy3U/s1600/storm_1.gif)
Fig. 2 降雨水文过程示意图

## 2. 降水-水文过程线图制作方法

降水-水文过程线图的制作方法其实特别简单，只需要以下步骤即可：

* 整理降水数据和径流数据，保证两者之间时间轴相同；
* 将径流数据设置成折线图或者散点图；
* 将降水数据设置成柱状图，投影到y轴副坐标轴，并反转坐标轴；
* 调整坐标轴的数据展示范围，以保证降水和径流数据图没有重叠。

以下笔者将展示不同软件的做法， 包括MS Excel, ggplot2 in R, matplotlib in Python, etc.

### 2.1 MS Excel

MS Excel 是大家非常熟悉的数据分析与可视化软件，
### 2.2 ggplot2 in R

ggplot2 是R中一款非常强大的数据可视化工具。

```{r hydrograph}
ggplot(clean_data, aes(x = dateTime))+
  geom_col(aes(y = precipitation ,  fill = "Precipitation" ))+
  geom_point(aes(y = discharge, color = "Discharge"))+
  geom_line(aes(y = discharge, color = "Discharge"))+
  scale_y_continuous(trans = "reverse",sec.axis = sec_axis(~ 1.5 - . / 125 , name = "Precipitation (cm)")
                     )
```














